<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Echo Downloader</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --bg:#0b0e14;
  --card:#121826;
  --panel:#0f1422;
  --accent:#5eead4;
  --accent2:#818cf8;
  --text:#e5e7eb;
  --muted:#9ca3af;
  --border:#1f2937;
  --danger:#f87171;
  --success:#34d399;
  --warning:#fbbf24;
}

*{box-sizing:border-box;margin:0;padding:0}

body{
  min-height:100vh;
  background:var(--bg);
  color:var(--text);
  font-family:system-ui,-apple-system,sans-serif;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:20px;
}

.card{
  width:100%;
  max-width:540px;
  background:var(--card);
  padding:28px;
  border-radius:20px;
  box-shadow:0 30px 80px rgba(0,0,0,.55);
}

.logo{
  font-family:monospace;
  white-space:pre;
  text-align:center;
  color:var(--accent);
  font-size:.8rem;
  margin-bottom:18px;
  animation:logoGlow 4s ease-in-out infinite;
  line-height:1.2;
}

@keyframes logoGlow{
  0%,100%{opacity:.75}
  50%{opacity:1}
}

.subtitle{
  text-align:center;
  font-size:.85rem;
  color:var(--muted);
  margin-bottom:22px;
}

input,select{
  width:100%;
  padding:13px 14px;
  margin-top:12px;
  border-radius:14px;
  border:1px solid var(--border);
  background:#0b1020;
  color:var(--text);
  font-size:.95rem;
  transition:border .2s;
}

input:focus,select:focus{
  outline:none;
  border-color:var(--accent);
}

input::placeholder{color:#6b7280}

.toggle{
  margin-top:14px;
  padding:12px 14px;
  background:var(--panel);
  border-radius:14px;
  border:1px solid var(--border);
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-size:.85rem;
}

.toggle input{
  width:44px;
  height:24px;
  appearance:none;
  background:#020617;
  border-radius:999px;
  position:relative;
  cursor:pointer;
  margin:0;
}
.toggle input:checked{
  background:linear-gradient(135deg,var(--accent),var(--accent2));
}
.toggle input::before{
  content:"";
  width:18px;
  height:18px;
  background:#fff;
  position:absolute;
  top:3px;
  left:4px;
  border-radius:50%;
  transition:.2s;
}
.toggle input:checked::before{left:22px}

button{
  margin-top:16px;
  width:100%;
  padding:14px;
  border-radius:14px;
  border:none;
  font-weight:700;
  cursor:pointer;
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  color:#020617;
  transition:filter .15s, transform .05s;
  font-size:.95rem;
}
button:hover:not(:disabled){filter:brightness(1.08)}
button:active:not(:disabled){transform:scale(.98)}
button:disabled{opacity:.5;cursor:not-allowed}

button.secondary{
  background:#0b1020;
  color:var(--text);
  border:1px solid var(--border);
}

button.danger{
  background:var(--danger);
  color:#fff;
}

.preview{
  margin-top:14px;
  padding:12px;
  background:var(--panel);
  border-radius:14px;
  border:1px solid var(--border);
  animation:fadeIn .3s;
}

@keyframes fadeIn{
  from{opacity:0;transform:translateY(-10px)}
  to{opacity:1;transform:translateY(0)}
}

.preview img{
  width:100%;
  border-radius:10px;
  display:block;
}

.preview-title{
  font-size:.9rem;
  margin-top:8px;
  font-weight:500;
}

.preview-error{
  color:var(--danger);
  font-size:.85rem;
}

.jobs{
  margin-top:22px;
}

.job{
  margin-top:12px;
  padding:14px;
  background:var(--panel);
  border-radius:14px;
  border:1px solid var(--border);
  animation:slideIn .3s;
}

@keyframes slideIn{
  from{opacity:0;transform:translateX(-20px)}
  to{opacity:1;transform:translateX(0)}
}

.job-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-size:.85rem;
  margin-bottom:8px;
}

.status{
  padding:4px 10px;
  border-radius:8px;
  font-weight:600;
  font-size:.75rem;
  text-transform:uppercase;
  letter-spacing:.5px;
}

.status.downloading{background:var(--accent2);color:#020617}
.status.done{background:var(--success);color:#020617}
.status.error{background:var(--danger);color:#fff}
.status.queued,.status.starting{background:var(--warning);color:#020617}
.status.cancelled{background:var(--muted);color:#020617}

.loader-container{
  display:flex;
  align-items:center;
  gap:10px;
  margin:8px 0;
}

.loader{
  width:24px;
  height:24px;
  border:3px solid var(--border);
  border-top-color:var(--accent);
  border-radius:50%;
  animation:spin 0.8s linear infinite;
}

.loader-text{
  font-size:.85rem;
  color:var(--muted);
}

@keyframes spin{
  to{transform:rotate(360deg)}
}

.job-meta{
  font-size:.75rem;
  color:var(--muted);
  margin-bottom:10px;
}

.job-title{
  font-size:.85rem;
  margin-bottom:8px;
  color:var(--text);
  word-break:break-word;
}

.spinner{
  display:inline-block;
  width:14px;
  height:14px;
  border:2px solid var(--border);
  border-top-color:var(--accent);
  border-radius:50%;
  animation:spin 1s linear infinite;
}

@keyframes spin{
  to{transform:rotate(360deg)}
}

.empty-state{
  text-align:center;
  padding:40px 20px;
  color:var(--muted);
  font-size:.9rem;
}

.alert{
  margin-top:12px;
  padding:12px;
  border-radius:12px;
  font-size:.85rem;
  animation:fadeIn .3s;
}

.alert.error{
  background:rgba(248,113,113,.1);
  border:1px solid var(--danger);
  color:var(--danger);
}

.alert.success{
  background:rgba(52,211,153,.1);
  border:1px solid var(--success);
  color:var(--success);
}
</style>
</head>

<body>
<div class="card">

<div class="logo">
    view me at tomjoejames.com

 ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó 
 ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ñà‚ñà‚ïó
 ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë
 ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  ‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë
 ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù
 ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù 
 
  Echo Downloader | By Tom Joe James
</div>

<div class="subtitle">
High-quality YouTube MP3 & MP4 downloader
</div>

<div class="toggle">
  <span id="modeLabel">Parallel mode</span>
  <input type="checkbox" id="queueToggle" onchange="toggleMode()">
</div>

<select id="formatSelect">
  <option value="mp3">üéµ MP3 ¬∑ 320 kbps Audio</option>
  <option value="mp4">üé¨ MP4 ¬∑ Best Quality Video</option>
</select>

<input id="urlInput" placeholder="Paste YouTube URL here..." autocomplete="off">

<div id="alertBox"></div>
<div id="previewBox"></div>

<button id="downloadBtn" onclick="startDownload()">
  <span id="btnText">Download</span>
</button>

<div id="jobsContainer" class="jobs"></div>

</div>

<script>
let previewTimer = null
let jobsData = {}

const urlInput = document.getElementById('urlInput')
const formatSelect = document.getElementById('formatSelect')
const previewBox = document.getElementById('previewBox')
const jobsContainer = document.getElementById('jobsContainer')
const downloadBtn = document.getElementById('downloadBtn')
const btnText = document.getElementById('btnText')
const alertBox = document.getElementById('alertBox')
const queueToggle = document.getElementById('queueToggle')
const modeLabel = document.getElementById('modeLabel')

function isYouTubeURL(url) {
  return /(?:youtube\.com\/watch\?v=|youtu\.be\/)[\w-]+/.test(url)
}

function showAlert(message, type = 'error') {
  alertBox.innerHTML = `<div class="alert ${type}">${message}</div>`
  setTimeout(() => alertBox.innerHTML = '', 5000)
}

// URL input handler with preview
urlInput.addEventListener('input', () => {
  clearTimeout(previewTimer)
  const url = urlInput.value.trim()

  previewBox.innerHTML = ''

  if (!url || !isYouTubeURL(url)) return

  previewBox.innerHTML = `
    <div class="preview">
      <div class="spinner"></div>
      <div class="preview-title">Loading preview...</div>
    </div>
  `

  previewTimer = setTimeout(() => {
    fetch('/info', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ url })
    })
    .then(r => {
      if (!r.ok) throw new Error('Failed to load preview')
      return r.json()
    })
    .then(data => {
      previewBox.innerHTML = `
        <div class="preview">
          <img src="${data.thumbnail}" alt="Thumbnail">
          <div class="preview-title">${data.title}</div>
        </div>
      `
    })
    .catch(err => {
      previewBox.innerHTML = `
        <div class="preview">
          <div class="preview-error">‚ö†Ô∏è ${err.message || 'Preview unavailable'}</div>
        </div>
      `
    })
  }, 600)
})

function toggleMode() {
  const isQueue = queueToggle.checked
  modeLabel.textContent = isQueue ? 'Queue mode' : 'Parallel mode'

  fetch('/mode', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ queue: isQueue })
  })
}

function startDownload() {
  const url = urlInput.value.trim()
  
  if (!url) {
    showAlert('Please enter a YouTube URL')
    return
  }

  if (!isYouTubeURL(url)) {
    showAlert('Please enter a valid YouTube URL')
    return
  }

  downloadBtn.disabled = true
  btnText.innerHTML = '<span class="spinner"></span> Starting...'

  fetch('/download', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ 
      url: url, 
      mode: formatSelect.value 
    })
  })
  .then(r => {
    if (!r.ok) throw new Error('Download failed to start')
    return r.json()
  })
  .then(data => {
    showAlert(`Download started! (${formatSelect.value.toUpperCase()})`, 'success')
    urlInput.value = ''
    previewBox.innerHTML = ''
  })
  .catch(err => {
    showAlert(err.message || 'Failed to start download')
  })
  .finally(() => {
    downloadBtn.disabled = false
    btnText.textContent = 'Download'
  })
}

// Enter key to download
urlInput.addEventListener('keypress', e => {
  if (e.key === 'Enter') startDownload()
})

function renderJobs(data) {
  const jobs = Object.entries(data)
  
  if (jobs.length === 0) {
    jobsContainer.innerHTML = '<div class="empty-state">No downloads yet</div>'
    return
  }

  jobsContainer.innerHTML = jobs.map(([id, job]) => {
    const isActive = ['downloading', 'starting'].includes(job.status)
    const isQueued = job.status === 'queued'
    
    return `
      <div class="job">
        <div class="job-title">
          ${job.mode === 'mp3' ? 'üéµ' : 'üé¨'} 
          ${job.title || 'Preparing download...'}
        </div>
        
        <div class="job-header">
          <span class="status ${job.status}">${job.status}</span>
        </div>
        
        ${isActive ? `
          <div class="loader-container">
            <div class="loader"></div>
            <div class="loader-text">Downloading from YouTube...</div>
          </div>
        ` : ''}
        
        ${isQueued ? `
          <div class="job-meta">‚è≥ Waiting in queue...</div>
        ` : ''}
        
        ${job.status === 'done' ? 
          `<button class="secondary" onclick="openFolder('${id}')">
            üìÅ Open Folder
          </button>` : 
          job.status === 'error' ?
          `<div class="job-meta" style="color:var(--danger)">‚ùå Download failed - file was empty or blocked</div>
          <button class="danger" onclick="removeJob('${id}')">
            Remove
          </button>` :
          `<button class="danger" onclick="cancelJob('${id}')">
            ‚èπÔ∏è Cancel
          </button>`
        }
      </div>
    `
  }).join('')
}

function openFolder(jobId) {
  fetch(`/open/${jobId}`)
    .then(() => showAlert('Opening folder...', 'success'))
    .catch(() => showAlert('Failed to open folder'))
}

function cancelJob(jobId) {
  fetch(`/cancel/${jobId}`, { method: 'POST' })
    .then(() => showAlert('Download cancelled', 'success'))
    .catch(() => showAlert('Failed to cancel'))
}

function removeJob(jobId) {
  fetch(`/cancel/${jobId}`, { method: 'POST' })
}

function pollProgress() {
  fetch('/progress')
    .then(r => r.json())
    .then(data => {
      jobsData = data
      renderJobs(data)
    })
    .catch(err => console.error('Poll error:', err))
}

// Poll every second
setInterval(pollProgress, 1000)
pollProgress() // Initial load
</script>

</body>
</html>